/* game namespace */
var game = {
 
    /** 
     * an object where to store game global data
     */
    data : {
        // score
        score : 0,
        clock : 80,
        nndata:[],
        lives: 5,
        fs: "",
        automode: false,
        nntoLoad: {"layers":[{"0":{},"1":{},"2":{},"3":{},"4":{},"5":{},"6":{},"7":{},"8":{},"9":{},"10":{},"11":{},"12":{},"13":{},"14":{},"15":{},"16":{},"17":{},"18":{},"19":{},"20":{},"21":{},"22":{},"23":{},"24":{}},{"0":{"bias":3.185216573282103,"weights":{"0":-6.284887958089319,"1":-12.80748611506874,"2":-8.582607491892901,"3":0.16724283248186111,"4":0.06647390164434908,"5":13.835596722843102,"6":12.774603405588415,"7":0.6467641782737389,"8":-0.014841271936893469,"9":0.04699655240401626,"10":-3.8896081793324218,"11":5.286334181049984,"12":-10.439307167138987,"13":-0.07401965297758581,"14":-0.181407967209816,"15":-0.045887400675565015,"16":-0.18543626023456455,"17":-0.04754518810659647,"18":-0.011065280623733992,"19":-0.1605483999475837,"20":-0.13189436430111529,"21":-0.14238139213994147,"22":-0.14214255791157485,"23":-0.1954137939028442,"24":-0.025177379325032223}},"1":{"bias":3.807786907304227,"weights":{"0":-21.25544024487291,"1":3.841010250963359,"2":-1.3386653892712446,"3":0.12184774857014419,"4":0.07340227589011195,"5":-0.24213043635994566,"6":8.475489631634375,"7":-3.79622847447886,"8":-0.1546926715411246,"9":0.1128419849090278,"10":4.074003186525455,"11":-10.21744403418588,"12":-8.266062202864918,"13":-0.15251676747575404,"14":-0.10214113108813763,"15":-0.03362846728414298,"16":-0.10048530399799348,"17":-0.1759741564281285,"18":0.008025236800313001,"19":0.1565138311125338,"20":0.010020654834806908,"21":-0.08062083870172501,"22":0.06485003633424641,"23":-0.16534192683175208,"24":-0.061416816897690296}},"2":{"bias":-8.518901993574582,"weights":{"0":13.396905082170566,"1":-3.977515399569428,"2":4.635610841245521,"3":0.08685514833778141,"4":-0.07185092717409133,"5":-1.941526791718689,"6":6.713157882159625,"7":-13.058165788801047,"8":0.04206897784024477,"9":-0.10210890825837851,"10":-2.533247798393309,"11":-3.182505310615385,"12":2.4890286481095245,"13":-0.09716857830062509,"14":-0.051937871146947145,"15":0.11227484345436095,"16":0.027190359588712465,"17":0.039643516950309265,"18":0.0477155501022935,"19":-0.10675728851929307,"20":-0.005661893449723732,"21":0.12658349191769958,"22":-0.13466634443029762,"23":0.10326998177915814,"24":0.18652298375964166}},"3":{"bias":-11.423361801216592,"weights":{"0":2.4864427790628922,"1":3.3964234655000087,"2":8.781876211787843,"3":-0.13438514238223434,"4":0.011021440848708153,"5":-15.98708723373373,"6":2.006554736207177,"7":20.085733255340912,"8":0.10244398703798652,"9":-0.004479977022856463,"10":11.50506917415411,"11":-1.9034312555211292,"12":15.792164031118455,"13":-0.18482555942609907,"14":-0.027072187047451735,"15":0.05918680429458617,"16":-0.04982477007433772,"17":-0.05490160156041385,"18":-0.07788059478625656,"19":0.12351156100630761,"20":0.14584113014861944,"21":0.17705318201333287,"22":0.14535382287576798,"23":0.0696223149076104,"24":-0.19776204004883768}},"4":{"bias":0.058023874907522664,"weights":{"0":3.0012742176130605,"1":-10.921488927721676,"2":11.776793802750243,"3":0.022203106433153152,"4":0.059359011240303516,"5":11.83352578827419,"6":5.049261630148036,"7":-7.737837795515311,"8":-0.005611435882747179,"9":-0.17906564008444548,"10":-5.423582470093174,"11":-1.25050862950023,"12":-14.482575278084315,"13":0.14451169744133952,"14":0.19119671154767276,"15":0.15892848148941996,"16":0.11526080481708051,"17":-0.17606870951130987,"18":-0.116292417421937,"19":0.12279994981363418,"20":-0.1138288819231093,"21":0.0640638595446944,"22":-0.16190845211967828,"23":-0.1820361045189202,"24":0.042063554469496}},"5":{"bias":-8.414538561788364,"weights":{"0":-11.634354808043659,"1":-1.1752517989899736,"2":-6.248034769048118,"3":0.15968220448121428,"4":-0.15525307003408673,"5":4.351089025340202,"6":12.949532743889344,"7":-12.120796145398858,"8":-0.0020493787713348754,"9":0.15784990917891267,"10":8.08640954799396,"11":16.334753287948438,"12":26.351160068661354,"13":0.16401671022176745,"14":-0.08799009704962374,"15":0.18010852504521607,"16":-0.15507507734000683,"17":-0.03659525914117695,"18":0.08139973217621443,"19":-0.1964839699678123,"20":0.11947986157611012,"21":-0.008256197534501547,"22":-0.01038858005777002,"23":0.11865715859457854,"24":0.18714017141610384}},"6":{"bias":-9.781761496719746,"weights":{"0":-3.043441827593778,"1":-2.0030397273555858,"2":-1.4188864329053277,"3":-0.008873972482979303,"4":-0.16175121078267696,"5":3.389816597057748,"6":2.610277897467729,"7":-1.341660557658573,"8":-0.05873610163107515,"9":-0.1026168117299676,"10":5.18449228722067,"11":-0.17849773682409487,"12":-0.3834567184848813,"13":-0.14725056840106845,"14":0.1164321769028902,"15":-0.047768926620483404,"16":-0.05348668592050673,"17":0.19754843963310126,"18":-0.1940251317806542,"19":0.18674151720479132,"20":-0.1520294091664255,"21":0.018494522850960482,"22":-0.05211214618757368,"23":0.11017208648845556,"24":-0.05055444706231357}},"7":{"bias":-5.4911050252586815,"weights":{"0":-1.7037612817764882,"1":-9.703780314701012,"2":-6.608902291284347,"3":0.03812809167429804,"4":-0.12299586134031415,"5":13.35381661918535,"6":-14.77591838158923,"7":-7.973178406570439,"8":-0.011238928046077484,"9":-0.1361060779541731,"10":9.190863692324358,"11":2.3969205481663978,"12":-5.310355053294336,"13":0.19731602491810918,"14":0.007744493801146751,"15":-0.06975992722436786,"16":0.07527048578485845,"17":-0.18138452442362907,"18":-0.06967397825792432,"19":-0.01605013431981206,"20":-0.08635642137378455,"21":0.019812207017093908,"22":0.05657426482066513,"23":-0.17139680106192828,"24":0.09897155100479721}},"8":{"bias":0.18334690965814127,"weights":{"0":-8.654098838026792,"1":7.109063436489182,"2":8.29631941824219,"3":0.01080101346597076,"4":0.13446266707032922,"5":-24.12282037461429,"6":19.373024744126667,"7":16.231249634524758,"8":-0.09201132897287607,"9":-0.14564050640910864,"10":11.812663725934701,"11":1.6766202650626039,"12":-5.336588892299302,"13":-0.17905028723180294,"14":0.19330824678763747,"15":-0.1420679028145969,"16":0.03653941843658687,"17":0.03198781600221992,"18":0.08074696371331813,"19":-0.11102156257256866,"20":0.15592801431193948,"21":0.06999210491776464,"22":-0.19151112055405975,"23":0.1013442326337099,"24":-0.1611339460127056}},"9":{"bias":-5.928520901112375,"weights":{"0":-4.593208561342836,"1":-13.437773111541429,"2":8.390482538470257,"3":-0.031411177199333895,"4":-0.019477683305740345,"5":2.840723050199266,"6":-8.852307346872735,"7":7.268203316364193,"8":-0.11172551270574332,"9":0.03366893101483584,"10":-4.8954558679530304,"11":11.25115139194121,"12":7.601188910086597,"13":0.07166101559996607,"14":0.16412226743996144,"15":0.19357282668352127,"16":-0.05061340983957052,"17":-0.0047451104037463665,"18":0.07166754547506571,"19":0.034308226592838775,"20":0.18329720906913283,"21":-0.19102581292390824,"22":-0.14469623379409313,"23":-0.13985481327399613,"24":0.02751639056950808}},"10":{"bias":8.061590682453826,"weights":{"0":-14.253225608501264,"1":4.311609965503493,"2":-5.376568094668864,"3":-0.17026521004736425,"4":-0.05015577981248498,"5":-24.551376029873413,"6":-1.0792451967858565,"7":-8.834597860812488,"8":0.19317422369495035,"9":-0.14775035222992303,"10":-1.440903311980316,"11":0.646608789389709,"12":1.9750127872999883,"13":-0.12051279023289681,"14":-0.10711126849055291,"15":-0.12128277625888587,"16":-0.17761065438389778,"17":0.11231022579595445,"18":0.14979624282568693,"19":0.04506903951987623,"20":0.03166495300829411,"21":0.17206318629905581,"22":0.08234954942017791,"23":0.060304951015859865,"24":-0.009409908857196558}},"11":{"bias":8.49305356117753,"weights":{"0":-1.76778717284258,"1":-2.4318597599370144,"2":-2.62108843591942,"3":0.1104109753854573,"4":-0.1364052196033299,"5":-27.422034190286016,"6":8.76347881098757,"7":2.265885252007888,"8":-0.13243366340175272,"9":0.08748850105330347,"10":-15.405192394992591,"11":6.755747596297175,"12":6.018491445721668,"13":0.08276880532503128,"14":0.038308001495897775,"15":0.03824042221531271,"16":-0.0009809265844523962,"17":0.11017402093857526,"18":-0.036293012928217655,"19":0.02030253121629358,"20":0.19289851170033218,"21":0.04103856412693857,"22":-0.07734624324366451,"23":-0.1466623015701771,"24":-0.0206669476814568}}},{"0":{"bias":-20.095256830606374,"weights":{"0":6.613308149206377,"1":21.714006188341994,"2":6.564914575692261,"3":9.711215246891227,"4":6.695498967114015,"5":-14.962718050033612,"6":6.298354739812645,"7":12.522771381805601,"8":4.8440928503249285,"9":7.599953147954807,"10":15.257244644385732,"11":6.296806725928192}}}]}
    },
     
    // Run on page load.
    "onload" : function () {
 
        // Initialize the video.
        if (!me.video.init("screen", 400, 300, false, 'auto')) {
            alert("Your browser does not support HTML5 canvas.");
            return;
        }
        me.debug.renderHitBox = true;
      
        // Initialize the audio.
        me.audio.init("mp3,ogg");
 
        // Set a callback to run when loading is complete.
        me.loader.onload = this.loaded.bind(this);
      
        // Load the resources.
        me.loader.preload(game.resources);
	
		// set the "Loading" Screen Object
        me.state.set(me.state.LOADING, new LoadingScreen());
		
        // Initialize melonJS and display a loading screen.
        me.state.change(me.state.LOADING);

        window.requestFileSystem(window.PERSISTENT, 1000*1000, this.onInitFs, function(e) { console.log("error in request file system" + e)});
    },
 
 
 
    // Run on game resources loaded.
    "loaded" : function () {
		// set the "Menu" Screen Object
                me.state.set(me.state.MENU, new MenuScreen());

        // set the "Play" Screen Object
                me.state.set(me.state.PLAY, new PlayScreen());

                // set the "Game over" Screen Object
                me.state.set(me.state.GAMEOVER, new GameOverScreen());

                // set a global fading transition for the screen
                me.state.transition("fade", "#FFFFFF", 250);

                // disable transition for MENU and GAMEOVER screen
               // me.state.setTransition(me.state.MENU, false);
               // me.state.setTransition(me.state.GAMEOVER, false);

        // enable the keyboard
        me.input.bindKey(me.input.KEY.LEFT, "left");
                me.input.bindKey(me.input.KEY.RIGHT, "right");
                me.input.bindKey(me.input.KEY.UP, "up");
                me.input.bindKey(me.input.KEY.DOWN, "down");
                me.input.bindKey(me.input.KEY.SPACE, "fire", true);

        // draw menu
                me.state.change(me.state.MENU);
    },

    onInitFs: function(fs) {
        game.data.fs = fs;
    }

};

/**
 * a HUD container and child items
 */
 
game.HUD = game.HUD || {};
 
  
game.HUD.Container = me.ObjectContainer.extend({
 
    init: function(x,y, timer) {
        // call the constructor
        this.parent();
         
        // persistent across level change
        this.isPersistent = true;
         
        // non collidable
        this.collidable = false;
         
        // make sure our object is always draw first
        this.z = Infinity;
 
        // give a name
        this.name = "HUD";
         
        // add our child score object at the right-bottom position
        this.addChild(new game.HUD.ScoreItem(x, y, timer));

        //add lives 

    }
});
 
 
/** 
 * a basic HUD item to display score
 */
game.HUD.ScoreItem = me.Renderable.extend({
    /** 
     * constructor
     */     
    init: function(x, y, type) {
        console.log("in init of HUD scoreitem");
         
        // call the parent constructor 
        // (size does not matter here)
        this.parent(new me.Vector2d(x, y), 10, 10); 
         
        // create a font
        this.font = new me.BitmapFont("32x32_font", 32);
        this.font.set("right");
         
        // local copy of the global score
        this.score = -1;
 
        // make sure we use screen coordinates
        this.floating = true;

        // set if this is a timer HUD
        this.type = type;
    },
     
    /**
     * update function
     */
    update : function () {  
        //console.log("type: " + this.type);
        if(this.type === 1) {
            if (this.score !== game.data.score) {
                this.score = game.data.score;
                return true;
            }
        } else if(this.type === 3) {
            if(this.score !== game.data.lives)    {
                this.score = game.data.lives;
                if(this.score === 0) {
                    me.state.change(me.state.GAMEOVER);
                }
                return true;
            }
        }else {            
            this.score = game.data.clock;
            if(this.score == 0) {
                /*var net = new brain.NeuralNetwork({learningRate: 0.3});
                console.log(net.train(game.data.nndata, {log:true, errorThresh:0.02, logPeriod:100, iterations:2000}));
                //WriteToFile(game.data.fs, "log.txt", JSON.stringify(net.toJSON()));
                var json = net.toJSON();
                var jsonstring = JSON.stringify(json);
                console.log(jsonstring);
                var net1 = new brain.NeuralNetwork();
                net1.fromJSON(json);
                //ReadFromFile(game.data.fs, "log.txt");*/
                me.state.change(me.state.GAMEOVER);
            }
            return true;
        }
        return false;
    },
 
    /**
     * draw the score
     */
    draw : function (context) {
        //console.log("drawing score");
        if(this.type === 1)
            this.font.draw (context, game.data.score, this.pos.x, this.pos.y);
        else if(this.type === 2)
            this.font.draw (context, game.data.clock, this.pos.x, this.pos.y);
        else
            this.font.draw (context, game.data.lives, this.pos.x, this.pos.y);
    }
});